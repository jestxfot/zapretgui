# Техническое задание для python-engineer

## Задача 1: Рефакторинг zapret2_settings_reset.py

**Проблема:** Файл `dpi/zapret2_settings_reset.py` напрямую работает с Windows реестром для сброса настроек категорий. Это нарушает архитектуру - настройки должны храниться в preset файлах через PresetManager.

**Текущая реализация:**
- `reset_category_settings(category_key)` - удаляет ключи из реестра (строки 89-122)
- `reset_all_categories_settings()` - удаляет целые секции реестра (строки 125-160)

**Новая реализация:**
1. Изменить `reset_category_settings(category_key)`:
   - Вызывать `PresetManager().reset_category_settings(category_key)`
   - Метод уже существует в `presets/preset_manager.py` строки 800-823
   - Возвращает `bool` (True/False)

2. Изменить `reset_all_categories_settings()`:
   - Получить список всех категорий из активного пресета
   - Вызвать `reset_category_settings()` для каждой категории
   - Возвращает `bool` (True если все успешно)

3. Оставить константы для обратной совместимости:
   - `DEFAULT_CATEGORY_SETTINGS` (строка 34)
   - `get_default_category_settings()` (строка 62)

**Важно:**
- После рефакторинга убрать импорты `winreg`, `REGISTRY_PATH`
- Сохранить docstrings и логирование
- PresetManager автоматически вызывает DPI reload через callback

**Файлы:**
- `dpi/zapret2_settings_reset.py` - рефакторить
- `presets/preset_manager.py` - использовать API

---

## Задача 2: Исправить форматирование preset файлов

**Проблема:** Preset файлы генерируются в одну строку вместо того чтобы каждый аргумент был на отдельной строке.

**Примеры:**

ТЕКУЩИЙ ВЫВОД (неправильно):
```
--lua-init=@C:\...\zapret-lib.lua --lua-init=@C:\...\zapret-antidpi.lua --wf-tcp-out=80,443 --blob=tls1:@bin/tls1.bin ...
```

ОЖИДАЕМЫЙ ВЫВОД (правильно):
```
--lua-init=@C:\ProgramData\ZapretTwoDev\lua\zapret-lib.lua
--lua-init=@C:\ProgramData\ZapretTwoDev\lua\zapret-antidpi.lua
--lua-init=@C:\ProgramData\ZapretTwoDev\lua\zapret-auto.lua
--wf-tcp-out=80,443
--blob=tls1:@bin/tls1.bin
...

--filter-tcp=443
--hostlist=youtube.txt
--lua-desync=multisplit:pos=1,midsld

--new

--filter-tcp=443
--hostlist=discord.txt
--lua-desync=fake:blob=tls7
```

**Анализ проблемы:**

1. Hex дамп показывает что между аргументами используется пробел (`0x20`) вместо `\n` (`0x0a`):
   ```
   lua --lua-init=...  (пробел между аргументами)
   ```

2. Парсинг работает правильно:
   - `txt_preset_parser.py` строка 311: `'\n'.join(line.strip()...)`
   - `generate_preset_content()` строки 381-383: правильно разбивает по `\n`

3. Значит проблема в записи файла или где-то аргументы соединяются через пробел.

**ПРИЧИНА НАЙДЕНА:**

Файл: `strategy_menu/__init__.py`
Функция: `regenerate_preset_file()` строки 795-830
Проблемная логика: строки 803-823

```python
# Строка 803-804: получает командную строку с ПРОБЕЛАМИ
combined = combine_strategies(**selections)
args_str = combined.get('args', '')  # "-- lua-init=... --wf-tcp-out=..."

# Строки 820-823: пытается разбить по \n, НО args_str содержит пробелы!
for line in args_str.split('\n'):
    line = line.strip()
    if line:
        f.write(f"{line}\n")
```

Функция `combine_strategies()` возвращает **командную строку** для запуска процесса, где аргументы разделены **пробелами**. Но код пытается разбить по `\n`, что не работает - в результате вся строка записывается целиком.

**План действий:**

1. ✅ **НАЙДЕНО:** `strategy_menu/__init__.py:803-823` - проблемная функция
2. **ИСПРАВИТЬ** `regenerate_preset_file()`:
   - Разбивать `args_str` по пробелам с учётом того что аргументы начинаются с `--`
   - Или использовать `shlex.split()` для правильного парсинга командной строки
   - Записывать каждый аргумент на отдельной строке

**Пример исправления:**

```python
import shlex

# Разбиваем командную строку на отдельные аргументы
try:
    args_list = shlex.split(args_str)
except Exception as e:
    log(f"Ошибка парсинга args_str: {e}", "WARNING")
    args_list = args_str.split()  # Фолбек на простой split

# Записываем каждый аргумент на отдельной строке
for arg in args_list:
    if arg.strip():
        f.write(f"{arg}\n")

        # Добавляем пустую строку после --new для читаемости
        if arg == "--new":
            f.write("\n")
```

**Важно:**
- После исправления файлы должны быть читаемы человеком
- Каждый `--` аргумент на отдельной строке
- `--new` на отдельной строке с пустыми строками до/после
- Unix line endings (`\n`), не CRLF (`\r\n`)

---

## Итоговая проверка

После выполнения обеих задач:

1. Запустить приложение
2. Проверить что сброс категории работает:
   ```python
   from dpi.zapret2_settings_reset import reset_category_settings
   reset_category_settings("youtube")
   ```
3. Проверить что preset файлы генерируются правильно:
   - Создать новый preset
   - Открыть файл в текстовом редакторе
   - Убедиться что каждый аргумент на отдельной строке

4. Запустить `qa-reviewer` для финальной проверки

---

## Контекст проекта

- **Режим:** direct_zapret2 (используем preset файлы, не реестр)
- **Путь к preset:** `C:\ProgramData\ZapretTwoDev\presets\`
- **Активный preset:** `preset-zapret2.txt` (симлинк/копия из presets/)
- **API:** PresetManager - единая точка для работы с preset файлами

## Файлы для изучения

Обязательно прочитай перед началом:
- `dpi/zapret2_settings_reset.py` - что нужно рефакторить
- `presets/preset_manager.py` - API для работы с preset
- `presets/txt_preset_parser.py` - парсинг/генерация txt файлов
- `presets/preset_storage.py` - сохранение preset в файл
